<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <title>ë¦¬ë·° ì‘ì„± í˜ì´ì§€</title>
    <style>
      body {
        padding-top: 20px;
        background-color: #f5f5f5;
      }
      .container {
        text-align: center;
        position: relative;
        display: flex;

        margin-bottom: 8%;
      }
      .container form {
        width: 600px;
        margin-right: 20px;
      }
      .my-3 {
        margin-bottom: 3rem !important;
      }
      .form-group {
        text-align: left;
      }
      .card-body {
        display: flex;
        flex-direction: column;
      }
      .header-image {
        height: 380px;
        position: absolute; /* absoluteë¡œ ì„¤ì • */
        width: 100%; /* ê°€ë¡œ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */

        background-image: url("../images/dog1.png");
        background-size: cover;
        background-position: center;

        opacity: 0.2;

        animation-name: scale-setting;
        animation-duration: 5s;
        animation-timing-function: linear;
        /*ë² ì§€ì–´ ì£¼ê¸° => ì²˜ìŒì— ë¹¨ë¦¬ ì‹¤í–‰ì‹œí‚¬ì§€ or ë‚˜ì¤‘ì— ë¹¨ë¦¬ ì‹¤í–‰ì‹œí‚¬ì§€ ë“± ì¡°ì ˆ ê°€ëŠ¥ */
        animation-iteration-count: infinite; /* ëª‡íšŒ ë°˜ë³µí• ê²ƒì¸ê°€ */
        transition: background-image 2s ease;

        z-index: 0;

        cursor: pointer;
      }

      #existing-review {
        height: 300px;
        width: 600px;
      }

      @keyframes scale-setting {
        0% {
          transform: scale(1); /* ì• ë‹ˆë©”ì´ì…˜ì´ 0%ë§Œí¼ ë™ì‘ì‹œ */
        }
        100% {
          transform: scale(1); /* ì• ë‹ˆë©”ì´ì…˜ì´ 100%ë§Œí¼ ë™ì‘ì‹œ */
        }
      }
    </style>
  </head>
  <body>
    <div class="header-image"></div>
    <div class="header">
      <!-- í—¤ë” -->
      <header class="text-center my-5" id="header-image" onmouseover="changeCursor()" onmouseout="restoreCursor()">
        <h1>í«ì‹œí„° ë§¤ì¹­ ì„œë¹„ìŠ¤ ğŸ¶</h1>
      </header>
    </div>
    <header class="text-center my-5">
      <h2 id="user-name">~~ë‹˜ì˜ ë¦¬ë·° ì‘ì„± í˜ì´ì§€</h2>
    </header>
    <div class="container">
      <!-- ë¦¬ë·° ì‘ì„± í¼ -->
      <form>
        <div class="form-group">
          <label for="reservation-title">ì˜ˆì•½ ì œëª©</label>
          <input type="text" class="form-control" id="reservation-title" placeholder="ì˜ˆì•½ ì œëª©" disabled />
        </div>
        <div class="form-group">
          <label for="reservation-date">ì˜ˆì•½ì¼ì</label>
          <input type="text" class="form-control" id="reservation-date" placeholder="YYYY-MM-DD" disabled />
        </div>
        <div class="form-group">
          <label for="sitter-name">í«ì‹œí„°</label>
          <input type="text" class="form-control" id="sitter-name" placeholder="í«ì‹œí„° ì´ë¦„" disabled />
        </div>
        <div class="form-group">
          <label for="reservation-content">ì˜ˆì•½ ë‚´ìš©</label>
          <textarea class="form-control" id="reservation-content" rows="3" disabled></textarea>
        </div>
        <div class="form-group">
          <label for="review-content">ë¦¬ë·° ë‚´ìš©</label>
          <textarea
            class="form-control"
            id="review-content"
            placeholder="ì„œë¹„ìŠ¤ê°€ ì–´ë– ì…¨ë‚˜ìš”? íšŒì›ë‹˜ì˜ ì„œë¹„ìŠ¤ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”~!"
            rows="5"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="star-rating">ë³„ì </label>
          <select class="form-control" id="star-rating">
            <option value="1">â­</option>
            <option value="2">â­â­</option>
            <option value="3">â­â­â­</option>
            <option value="4">â­â­â­â­</option>
            <option value="5">â­â­â­â­â­</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">ë¦¬ë·° ì €ì¥</button>
        <button type="button" class="btn btn-danger" id="back-button">ë’¤ë¡œ</button>
      </form>
      <!-- ë¦¬ë·°ê°€ ì´ë¯¸ ì¡´ì¬í•  ê²½ìš° í‘œì‹œí•  ë¶€ë¶„ -->
      <div id="existing-review" class="card mt-4" style="display: none">
        <div class="card-body">
          <h3 class="card-title">REVIEW</h3>
          <p class="card-text" id="existing-review-content"></p>
          <p class="card-text" id="existing-star-rating"></p>
          <p class="card-text" id="existing-nickname"></p>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      $(document).ready(function () {
        // URLì—ì„œ bookingId ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get("bookingId");

        // bookingIdê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í•¨ìˆ˜ ì‹¤í–‰
        if (bookingId) {
          loadBookingInfo(bookingId);
        } else {
          alert("ì˜ˆì•½ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        function loadReviewInfo(bookingId) {
          $.ajax({
            url: `http://localhost:4002/api/review/${bookingId}`,
            type: "GET",
            success: function (reviewResponse) {
              if (reviewResponse.success && reviewResponse.data.reviews.length > 0) {
                // ê°€ì¥ ìµœê·¼ ë¦¬ë·°ë¥¼ í‘œì‹œ
                const latestReview = reviewResponse.data.reviews[0];
                const review = latestReview.review;
                const stars = "â­".repeat(latestReview.star);

                $("#existing-review-content").text(review);
                $("#existing-star-rating").text(stars);
                $("#existing-nickname").text(`<${latestReview.users.nickname}>`);
                $("#existing-review").show();
              } else {
                // ë¦¬ë·°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                /* ë¦¬ë·° ì—†ì–´ë„ ê³µê°„ ì°¨ì§€í•˜ë„ë¡ ìˆ˜ì • 23.12.18*/
                //$("#existing-review").hide();

                $("#existing-review-content").text("ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                $("#existing-review").show();
              }
            },
            error: function () {
              // ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í•œ ê²½ìš°
              alert("ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              $("#existing-review").hide();
            }
          });
        }

        // ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        function loadBookingInfo(bookingId) {
          $.ajax({
            url: `http://localhost:4002/api/booking/${bookingId}`,
            type: "GET",
            success: function (bookingResponse) {
              // ë‚ ì§œ í˜•ì‹ ë³€í™˜
              console.log(bookingResponse);
              const bookedDate = new Date(bookingResponse.data.bookedAt);
              const formattedDate = bookedDate.toLocaleDateString("ko-KR");

              // ìˆ˜ì •ëœ ë°ì´í„° ì ‘ê·¼ ë°©ì‹
              $("#reservation-title").val(bookingResponse.data.title);
              $("#reservation-date").val(formattedDate);
              $("#reservation-content").val(bookingResponse.data.content);

              console.log("sitterId:", bookingResponse.data.sitterId); // ì—¬ê¸°ì—ì„œ sitterId ê°’ì„ í™•ì¸
              // ì˜¬ë°”ë¥¸ sitterId ê°’ ì¶”ì¶œ
              const sitterId = bookingResponse.data.sitterId;
              console.log("sitterId:", sitterId); // ìˆ˜ì •ëœ sitterId í™•ì¸
              const userId = bookingResponse.data.userId;
              console.log("userId:", userId);
              const nickname = bookingResponse.data.nickname;
              console.log("nickname:", nickname);
              $("#user-name").text(nickname + "ë‹˜ì˜ ë¦¬ë·° ì‘ì„± í˜ì´ì§€");

              // í«ì‹œí„° ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
              loadSitterInfo(sitterId);
              loadReviewInfo(bookingId);
            },
            error: function () {
              alert("ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }

        // í«ì‹œí„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        function loadSitterInfo(sitterId) {
          $.ajax({
            url: `http://localhost:4002/api/sitter/${sitterId}`,
            type: "GET",
            success: function (sitterResponse) {
              // í«ì‹œí„° ì´ë¦„ í‘œì‹œ
              $("#sitter-name").val(sitterResponse.data.name);
            },
            error: function () {
              alert("í«ì‹œí„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }
        // ë¦¬ë·° ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        $("form").on("submit", function (event) {
          event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ ë™ì‘ì„ ë°©ì§€

          // ë¦¬ë·° ë‚´ìš©ê³¼ ë³„ì  ê°€ì ¸ì˜¤ê¸°
          var reviewContent = $("#review-content").val();
          var starRating = $("#star-rating").val();
          const starValue = parseInt(starRating, 10);

          // AJAXë¥¼ ì‚¬ìš©í•˜ì—¬ POST ìš”ì²­ ë³´ë‚´ê¸°
          $.ajax({
            url: `http://localhost:4002/api/review/${bookingId}`, // POST ìš”ì²­ì„ ë³´ë‚¼ ì„œë²„ì˜ ì£¼ì†Œ
            type: "POST",
            contentType: "application/json", // ìš”ì²­ ë³¸ë¬¸ì˜ íƒ€ì…
            data: JSON.stringify({ review: reviewContent, star: starValue }), // ì „ì†¡í•  ë°ì´í„°
            success: function (response) {
              // ì„±ê³µ ì‹œ ì‹¤í–‰ë  ì½”ë“œ
              alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
              location.reload();
            },
            error: function () {
              // ì‹¤íŒ¨ ì‹œ ì‹¤í–‰ë  ì½”ë“œ
              alert("ë¦¬ë·° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        });
      });

      window.addEventListener("load", async (event) => {
        //repeatScalingAnimation();
        const scalingElement = document.querySelector(".header-image");

        scalingElement.addEventListener("animationiteration", function () {
          // ì• ë‹ˆë©”ì´ì…˜ ë°˜ë³µ ì‹œ ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
          const currentImage = scalingElement.style.backgroundImage;
          let changeImageUrl = 'url("../images/dog1.png")';

          if (currentImage.includes("dog1.png")) changeImageUrl = 'url("../images/dog2.png")';
          else if (currentImage.includes("dog2.png")) changeImageUrl = 'url("../images/dog3.png")';
          else scalingElement.style.backgroundImage = 'url("../images/dog1.png")';

          scalingElement.style.backgroundImage = changeImageUrl;
        });

        // í˜ì´ì§€ ë¡œë“œ í›„ ìŠ¤ì¼€ì¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        scalingElement.classList.add("animated");
      });
      // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
      document.getElementById("back-button").addEventListener("click", function () {
        location.href = "main.html";
      });

      // í«ì‹œí„° ë§¤ì¹­ ì„œë¹„ìŠ¤ ì œëª© í´ë¦­ì‹œ ë©”ì¸í˜ì´ì§€ ì´ë™
      document.querySelector(".header-image").addEventListener("click", function () {
        location.href = "main.html";
      });
    </script>
  </body>
</html>
